id: io.github.mpvqc.mpvQC
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: mpvQC

finish-args:
  - --device=dri
  - --filesystem=home
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio

build-options:
  cflags: -O2
  cxxflags: -O2

cleanup:
  - /include
  - /lib/pkgconfig
  - /man
  - /share/doc
  - /share/gtk-doc
  - /share/man
  - '*.la'
  - '*.a'

modules:
  - io.github.mpvqc.mpvQC.pypi.yml

  - name: luajit
    no-autogen: true
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: git
        url: https://github.com/LuaJIT/LuaJIT.git
        disable-shallow-clone: true
        commit: f9140a622a0c44a99efb391cc1c2358bc8098ab7
        x-checker-data:
          type: json
          url: https://api.github.com/repos/LuaJIT/LuaJIT/branches/v2.1
          commit-query: .commit.sha
          version-query: .commit.sha
          timestamp-query: .commit.commit.committer.date
      - type: shell
        commands:
          - sed -i 's|/usr/local|/app|' ./Makefile

  - name: uchardet
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_STATIC=0
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: archive
        url: https://www.freedesktop.org/software/uchardet/releases/uchardet-0.0.8.tar.xz
        sha256: e97a60cfc00a1c147a674b097bb1422abd9fa78a2d9ce3f3fdcc2e78a34ac5f0
        x-checker-data:
          type: html
          url: https://www.freedesktop.org/software/uchardet/releases/
          version-pattern: uchardet-(\d\.\d+\.?\d*).tar.xz
          url-template: https://www.freedesktop.org/software/uchardet/releases/uchardet-$version.tar.xz

  - name: libass
    cleanup:
      - /include
      - /lib/pkgconfig
    config-opts:
      - --disable-static
      - --enable-asm
      - --enable-harfbuzz
      - --enable-fontconfig
    sources:
      - type: git
        url: https://github.com/libass/libass.git
        tag: 0.17.4
        commit: bbb3c7f1570a4a021e52683f3fbdf74fe492ae84
        x-checker-data:
          type: git
          tag-pattern: ^(\d\.\d{1,3}\.\d{1,2})$

  - name: zimg
    config-opts:
      - --disable-static
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/doc
    sources:
      - type: archive
        archive-type: tar
        url: https://api.github.com/repos/sekrit-twc/zimg/tarball/release-3.0.5
        sha256: 1b8998f03f4a49e4d730033143722b32bc28a5306ef809ccfb3b4bbb29e4b784
        x-checker-data:
          type: json
          url: https://api.github.com/repos/sekrit-twc/zimg/releases/latest
          url-query: .tarball_url
          version-query: .tag_name | sub("^release-"; "")
          timestamp-query: .published_at

  - name: rubberband
    buildsystem: meson
    cleanup:
      - /include
      - /lib/pkgconfig
    sources:
      - type: git
        url: https://github.com/breakfastquay/rubberband.git
        tag: v4.0.0
        commit: 1d95888bec3ae0a17c0c4af791810d5a63f6bc35
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: mujs
    buildsystem: autotools
    no-autogen: true
    make-args:
      - release
    make-install-args:
      - prefix=/app
      - install-shared
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
    sources:
      - type: git
        url: https://github.com/ccxvii/mujs.git
        tag: 1.3.6
        commit: cc569c5fa9a7a2498177693b5617605c2ff5b260
        x-checker-data:
          type: git
          url: https://api.github.com/repos/ccxvii/mujs/tags
          tag-pattern: ^([\d.]+)$

  - name: nv-codec-headers
    cleanup:
      - '*'
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    sources:
      - type: git
        url: https://github.com/FFmpeg/nv-codec-headers.git
        tag: n13.0.19.0
        commit: e844e5b26f46bb77479f063029595293aa8f812d
        x-checker-data:
          type: git
          tag-pattern: ^n([\d.]+)$

  - name: ffmpeg
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/ffmpeg/examples
    config-opts:
      - --disable-debug
      - --disable-doc
      - --disable-libv4l2
      - --disable-programs              # libs only (keep if you don’t need ffmpeg/ffprobe)
      - --disable-static
      - --enable-encoder=png
      - --enable-gnutls
      - --enable-gpl
      - --enable-shared
      - --enable-version3
      - --enable-libass
      - --enable-libdav1d
      - --enable-libfreetype
      - --enable-nvenc
      - --enable-shared
      - --enable-vaapi
      - --enable-version3
      - --enable-vulkan
    sources:
      - type: git
        url: https://github.com/FFmpeg/FFmpeg.git
        tag: n7.1.1
        commit: db69d06eeeab4f46da15030a80d539efb4503ca8

  - name: vapoursynth
    config-opts:
      - --with-python-prefix=${FLATPAK_DEST}
    sources:
      - type: archive
        url: https://github.com/vapoursynth/vapoursynth/archive/72.tar.gz
        sha256: f8fcc5e2e9d2195454310e3356ea13e5334125891e452cc6543e985f28cacd22
        x-checker-data:
          type: anitya
          project-id: 15982
          stable-only: true
          url-template: https://github.com/vapoursynth/vapoursynth/archive/$version.tar.gz

  - name: libplacebo
    buildsystem: meson
    config-opts:
      - -Dvulkan=enabled
      - -Dshaderc=enabled
    cleanup:
      - /include
      - /lib/pkgconfig
    sources:
      - type: git
        url: https://github.com/haasn/libplacebo.git
        tag: v7.349.0
        commit: 1fd3c7bde7b943fe8985c893310b5269a09b46c5
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dbuild-date=false
      - -Dcdda=disabled
      - -Ddvbin=disabled # drop DVB: not needed for libmpv usage
      - -Ddvdnav=disabled
      - -Dlibarchive=enabled
      - -Dlibmpv=true
      - -Dmanpage-build=disabled
      - -Drubberband=enabled
      - -Dsdl2=disabled # libmpv doesn’t need SDL2
      - -Dvapoursynth=enabled
      - -Dvulkan=enabled
      - -Dzimg=enabled
    cleanup:
      - /include
      - /lib/pkgconfig
    sources:
      - type: git
        url: https://github.com/mpv-player/mpv.git
        tag: v0.40.0
        commit: e48ac7ce08462f5e33af6ef9deeac6fa87eef01e
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  # https://github.com/flathub/io.qt.qtwebengine.BaseApp/tree/branch/6.7/krb5
  - name: krb5
    subdir: src
    cleanup:
      - /bin
      - /share/et
      - /share/examples
      - /share/man
    config-opts:
      - --localstatedir=/var/lib
      - --sbindir=${FLATPAK_DEST}/bin
      - --disable-rpath
      - --disable-static
    post-install:
      - install -Dm644 ../krb5.conf -t ${FLATPAK_DEST}/etc/
    sources:
      - type: file
        path: krb5.conf
      - type: archive
        url: https://kerberos.org/dist/krb5/1.21/krb5-1.21.2.tar.gz
        sha256: 9560941a9d843c0243a71b17a7ac6fe31c7cebb5bce3983db79e52ae7e850491

  - name: mpvQC
    buildsystem: simple
    build-commands:
      - mkdir -p /app/my-app
      - cp -r mpvqc /app/my-app
      - install -D main.py /app/my-app
      - install -Dm644 io.github.mpvqc.mpvQC.svg /app/share/icons/hicolor/scalable/apps/io.github.mpvqc.mpvQC.svg
      - install -Dm644 io.github.mpvqc.mpvQC.desktop /app/share/applications/io.github.mpvqc.mpvQC.desktop
      - install -Dm644 io.github.mpvqc.mpvQC.metainfo.xml -t /app/share/metainfo
      - install -Dm755 launch.sh /app/bin/launch.sh
      - ln -s /app/bin/launch.sh /app/bin/mpvQC
    sources:
      - type: file
        path: launch.sh
      - type: file
        path: io.github.mpvqc.mpvQC.desktop
      - type: file
        path: io.github.mpvqc.mpvQC.metainfo.xml
      - type: file
        path: io.github.mpvqc.mpvQC.svg

      - type: archive
        url: https://github.com/mpvqc/mpvQC/releases/download/0.9.0-beta1/release-build-linux.zip
        sha256: 3a475d9574083d08df3c99af91c6f41675fb626208de5494b6042712a4957c91
        strip-components: 0

        # local testing
        # - type: dir
        #  path: /home/elias/PycharmProjects/mpvQC/build/release
