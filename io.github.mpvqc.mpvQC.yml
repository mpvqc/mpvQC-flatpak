id: io.github.mpvqc.mpvQC
runtime: org.freedesktop.Platform
runtime-version: '25.08'
sdk: org.freedesktop.Sdk
command: mpvQC

finish-args:
  - --device=dri
  # Home filesystem access required for:
  # - Opening video files from user-specified locations
  # - Saving QC reports and exports to user-chosen directories
  # - Loading subtitle files and project documents
  - --filesystem=home
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --filesystem=xdg-run/pipewire-0:ro

#add-extensions:
#  org.freedesktop.Platform.codecs-extra:
#    directory: lib/codecs
#    version: '25.08'
#    add-ld-path: lib
#    autodelete: false

build-options:
  cflags: -O3 -march=x86-64-v2
  cxxflags: -O3 -march=x86-64-v2
  strip: true

cleanup:
  - /include
  - /lib/pkgconfig
  - /man
  - /share/doc
  - /share/gtk-doc
  - /share/man
  - '*.la'
  - '*.a'

modules:
  - io.github.mpvqc.mpvQC.pypi.yml

  - name: luajit
    build-options:
      cflags: -O2 -fno-lto
      cxxflags: -O2 -fno-lto
    no-autogen: true
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: git
        url: https://github.com/LuaJIT/LuaJIT.git
        disable-shallow-clone: true
        commit: 7152e15489d2077cd299ee23e3d51a4c599ab14f
        x-checker-data:
          type: json
          url: https://api.github.com/repos/LuaJIT/LuaJIT/branches/v2.1
          commit-query: .commit.sha
          version-query: .commit.sha
          timestamp-query: .commit.commit.committer.date
      - type: shell
        commands:
          - sed -i 's|/usr/local|/app|' ./Makefile

  - name: uchardet
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_STATIC=0
      - -DCMAKE_POLICY_VERSION_MINIMUM=3.5 # TODO can be removed when updating to uchardet > 0.0.8
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: archive
        url: https://www.freedesktop.org/software/uchardet/releases/uchardet-0.0.8.tar.xz
        sha256: e97a60cfc00a1c147a674b097bb1422abd9fa78a2d9ce3f3fdcc2e78a34ac5f0
        x-checker-data:
          type: html
          url: https://www.freedesktop.org/software/uchardet/releases/
          version-pattern: uchardet-(\d\.\d+\.?\d*).tar.xz
          url-template: https://www.freedesktop.org/software/uchardet/releases/uchardet-$version.tar.xz

  - name: libass
    cleanup:
      - /include
      - /lib/pkgconfig
    config-opts:
      - --disable-static
      - --enable-asm
      - --enable-harfbuzz
      - --enable-fontconfig
    sources:
      - type: git
        url: https://github.com/libass/libass.git
        tag: 0.17.4
        commit: bbb3c7f1570a4a021e52683f3fbdf74fe492ae84
        x-checker-data:
          type: git
          tag-pattern: ^(\d\.\d{1,3}\.\d{1,2})$

  - name: zimg
    config-opts:
      - --disable-static
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/doc
    sources:
      - type: archive
        archive-type: tar
        url: https://api.github.com/repos/sekrit-twc/zimg/tarball/release-3.0.6
        sha256: 15140e491c4ce9db5f02a038d8a1eb53e9151b55eeed06a2899425a6ebfef367
        x-checker-data:
          type: json
          url: https://api.github.com/repos/sekrit-twc/zimg/releases/latest
          url-query: .tarball_url
          version-query: .tag_name | sub("^release-"; "")
          timestamp-query: .published_at

  - name: rubberband
    buildsystem: meson
    cleanup:
      - /include
      - /lib/pkgconfig
    sources:
      - type: git
        url: https://github.com/breakfastquay/rubberband.git
        tag: v4.0.0
        commit: 1d95888bec3ae0a17c0c4af791810d5a63f6bc35
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: mujs
    buildsystem: autotools
    no-autogen: true
    make-args:
      - release
    make-install-args:
      - prefix=/app
      - install-shared
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
    sources:
      - type: git
        url: https://github.com/ccxvii/mujs.git
        tag: 1.3.6
        commit: cc569c5fa9a7a2498177693b5617605c2ff5b260
        # failing build for 1.3.7
        #x-checker-data:
        #  type: git
        #  url: https://api.github.com/repos/ccxvii/mujs/tags
        #  tag-pattern: ^([\d.]+)$

  - name: ffmpeg
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/ffmpeg/examples
    config-opts:
      - --disable-debug
      - --disable-doc
      - --disable-libv4l2
      - --disable-programs
      - --disable-static
      - --enable-encoder=png
      - --enable-gnutls
      - --enable-gpl
      - --enable-libass
      - --enable-libdav1d
      - --enable-libdrm
      - --enable-libfreetype
      - --enable-libopus
      - --enable-libvorbis
      - --enable-libvpx
      - --enable-lto
      - --enable-shared
      - --enable-vaapi
      - --enable-version3
      - --enable-vulkan
    sources:
      - type: git
        url: https://github.com/FFmpeg/FFmpeg.git
        tag: n8.0.1
        commit: 894da5ca7d742e4429ffb2af534fcda0103ef593
        x-checker-data:
          type: git
          tag-pattern: ^n([\d.]{3,7})$

  - name: vapoursynth
    config-opts:
      - --with-python-prefix=${FLATPAK_DEST}
    sources:
      - type: archive
        url: https://github.com/vapoursynth/vapoursynth/archive/72.tar.gz
        sha256: f8fcc5e2e9d2195454310e3356ea13e5334125891e452cc6543e985f28cacd22
        x-checker-data:
          type: anitya
          project-id: 15982
          stable-only: true
          url-template: https://github.com/vapoursynth/vapoursynth/archive/$version.tar.gz

  - name: libplacebo
    buildsystem: meson
    config-opts:
      - -Dvulkan=enabled
      - -Dshaderc=enabled
      - -Ddemos=false
      - -Db_lto=true
    cleanup:
      - /include
      - /lib/pkgconfig
    sources:
      - type: git
        url: https://github.com/haasn/libplacebo.git
        #        tag: v7.351.0
        commit: 06992a53fafc1549843c8b36751e166cfe3a4079
        # x-checker-data:
        #   type: git
        #   tag-pattern: ^v([\d.]+)$

  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dbuild-date=false
      - -Dcdda=disabled
      - -Ddvbin=disabled
      - -Ddvdnav=disabled
      - -Dlibarchive=enabled
      - -Dlibmpv=true
      - -Dmanpage-build=disabled
      - -Drubberband=enabled
      - -Dsdl2=disabled
      - -Dvapoursynth=enabled
      - -Dvulkan=enabled
      - -Dzimg=enabled
      - -Db_lto=true
    cleanup:
      - /include
      - /lib/pkgconfig
    sources:
      - type: git
        url: https://github.com/mpv-player/mpv.git
        tag: v0.40.0
        commit: e48ac7ce08462f5e33af6ef9deeac6fa87eef01e
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

      # required to build against ffmpeg 8.0
      # https://github.com/mpv-player/mpv/commit/26b29fba02a2782f68e2906f837d21201fc6f1b9
      - type: patch
        path: patches/demux_mkv-fix-compilation-after-deprecated-definitio.patch

  # https://github.com/flathub/io.qt.qtwebengine.BaseApp/tree/branch/6.7/krb5
  - name: krb5
    subdir: src
    cleanup:
      - /bin
      - /share/et
      - /share/examples
      - /share/man
    config-opts:
      - --localstatedir=/var/lib
      - --sbindir=${FLATPAK_DEST}/bin
      - --disable-rpath
      - --disable-static
    post-install:
      - install -Dm644 ../krb5.conf -t ${FLATPAK_DEST}/etc/
    sources:
      - type: archive
        url: https://kerberos.org/dist/krb5/1.22/krb5-1.22.1.tar.gz
        sha256: 1a8832b8cad923ebbf1394f67e2efcf41e3a49f460285a66e35adec8fa0053af
        x-checker-data:
          type: html
          url: https://kerberos.org/dist/
          version-pattern: Kerberos V5 Release ([\d\.-]*) - current release
          url-template: https://kerberos.org/dist/krb5/$version0.$version1/krb5-$version.tar.gz
      - type: file
        path: krb5.conf

  - name: mpvQC
    buildsystem: simple
    build-commands:
      - mkdir -p /app/my-app
      - cp -r mpvqc /app/my-app
      - install -D main.py /app/my-app
      - install -D rc_project.py /app/my-app
      - install -Dm644 io.github.mpvqc.mpvQC.svg /app/share/icons/hicolor/scalable/apps/io.github.mpvqc.mpvQC.svg
      - install -Dm644 io.github.mpvqc.mpvQC.desktop /app/share/applications/io.github.mpvqc.mpvQC.desktop
      - install -Dm644 io.github.mpvqc.mpvQC.metainfo.xml -t /app/share/metainfo
      - install -Dm755 launch.sh /app/bin/launch.sh
      - ln -s /app/bin/launch.sh /app/bin/mpvQC

      # Copy all licenses
      - mkdir -p ${FLATPAK_DEST}/share/licenses/$FLATPAK_ID
      - cp Apache-2.0.txt ${FLATPAK_DEST}/share/licenses/$FLATPAK_ID
      - cp BSD-3-Clause.txt ${FLATPAK_DEST}/share/licenses/$FLATPAK_ID
      - cp GPL-3.0-or-later.txt ${FLATPAK_DEST}/share/licenses/$FLATPAK_ID
      - cp LGPL-3.0.txt ${FLATPAK_DEST}/share/licenses/$FLATPAK_ID
      - cp MIT.txt ${FLATPAK_DEST}/share/licenses/$FLATPAK_ID
      - cp OFL-1.1.txt ${FLATPAK_DEST}/share/licenses/$FLATPAK_ID
      - cp PSF-2.0.txt ${FLATPAK_DEST}/share/licenses/$FLATPAK_ID
    sources:
      - type: dir
        path: dependency-licenses
      - type: file
        path: launch.sh
      - type: file
        path: io.github.mpvqc.mpvQC.desktop
      - type: file
        path: io.github.mpvqc.mpvQC.metainfo.xml
      - type: file
        path: io.github.mpvqc.mpvQC.svg

      - type: archive
        url: https://github.com/mpvqc/mpvQC/releases/download/0.9.0-beta3/release-build-linux.zip
        sha256: b907f62b7957229a5fb7c0e2ae64acd8b827e0df81571db19a7275b64a8dea5a
        strip-components: 0

        # local testing
        # - type: dir
        #  path: /home/elias/PycharmProjects/mpvQC/build/release
